# EYM Agent ネイティブ版ビルド手順

## 前提条件の確認

### 1. Visual Studio Build Tools のインストール

**必須**: C++コンパイラが必要です。

#### オプション A: Visual Studio Community 2022 (推奨)
1. [Visual Studio Community 2022](https://visualstudio.microsoft.com/ja/vs/community/) をダウンロード
2. インストーラーを実行
3. **「C++によるデスクトップ開発」** ワークロードを選択
4. 以下のコンポーネントが含まれていることを確認：
   - MSVC v143 - VS 2022 C++ x64/x86 build tools
   - Windows 10/11 SDK (最新版)
   - CMake tools for Visual Studio

#### オプション B: Build Tools for Visual Studio 2022
1. [Build Tools for Visual Studio 2022](https://visualstudio.microsoft.com/ja/downloads/#build-tools-for-visual-studio-2022) をダウンロード
2. インストーラーを実行
3. **「C++ build tools」** を選択
4. 必要なコンポーネントを選択してインストール

### 2. 環境確認

インストール後、新しいPowerShellを開いて確認：

```powershell
# C++コンパイラの確認
where cl

# CMakeの確認
where cmake

# Flutter環境の確認
flutter doctor -v
```

## ネイティブ版ビルド手順

### 1. プロジェクトのクリーンアップ

```bash
flutter clean
flutter pub get
```

### 2. Windowsネイティブ版のビルド

#### デバッグ版（開発・テスト用）
```bash
flutter build windows --debug
```

#### リリース版（配布用）
```bash
flutter build windows --release
```

### 3. 実行ファイルの場所

ビルド成功後、実行ファイルは以下に生成されます：

**デバッグ版**:
```
build/windows/x64/runner/Debug/qrsc_pc.exe
```

**リリース版**:
```
build/windows/x64/runner/Release/qrsc_pc.exe
```

### 4. 実行方法

#### 直接実行
```bash
# デバッグ版
./build/windows/x64/runner/Debug/qrsc_pc.exe

# リリース版
./build/windows/x64/runner/Release/qrsc_pc.exe
```

#### Flutter経由で実行
```bash
flutter run -d windows
```

## 配布用パッケージの作成

### 1. 必要なファイルをコピー

リリース版の場合、以下のフォルダ全体が必要です：
```
build/windows/x64/runner/Release/
├── qrsc_pc.exe          # メイン実行ファイル
├── flutter_windows.dll   # Flutter ランタイム
├── data/                  # アプリデータ
└── その他のDLLファイル
```

### 2. 配布用フォルダの作成

```bash
# 配布用フォルダを作成
mkdir EYM_Agent_Windows

# 必要なファイルをコピー
cp -r build/windows/x64/runner/Release/* EYM_Agent_Windows/

# READMEとドキュメントをコピー
cp README.md EYM_Agent_Windows/
cp "アプリ起動方法.md" EYM_Agent_Windows/
cp test_client.py EYM_Agent_Windows/
```

## トラブルシューティング

### エラー: "CMake Error: No CMAKE_CXX_COMPILER could be found"

**原因**: C++コンパイラがインストールされていない

**解決方法**:
1. Visual Studio Community 2022をインストール
2. 「C++によるデスクトップ開発」ワークロードを選択
3. 新しいPowerShellを開いて再実行

### エラー: "Visual Studio not found"

**原因**: Visual Studioが正しくインストールされていない

**解決方法**:
```bash
# Flutter環境を確認
flutter doctor -v

# Visual Studioの項目が✓になっているか確認
```

### エラー: "Windows SDK not found"

**原因**: Windows SDKがインストールされていない

**解決方法**:
1. Visual Studio Installerを開く
2. 「変更」をクリック
3. 「個別のコンポーネント」タブ
4. 「Windows 10 SDK」または「Windows 11 SDK」を選択
5. インストールを実行

### ビルドが遅い場合

```bash
# 並列ビルドを有効化
flutter build windows --release --verbose
```

## 完成後の確認事項

### 1. 機能テスト

1. **アプリケーション起動**: `qrsc_pc.exe`をダブルクリック
2. **サーバー起動確認**: ログに「サーバーを開始しました: http://localhost:8765」が表示される
3. **設定画面**: 設定ボタンが正常に動作する
4. **ショートカット設定**: アプリケーションパスを設定できる
5. **アプリケーション起動**: テストボタンでアプリが起動する

### 2. API テスト

```bash
# ヘルスチェック
curl http://localhost:8765/health

# または PowerShell
Invoke-WebRequest -Uri "http://localhost:8765/health"
```

### 3. スマホアプリとの連携テスト

```bash
# テストクライアントを使用
python test_client.py
```

## 配布時の注意事項

1. **Visual C++ 再頒布可能パッケージ**: エンドユーザーのPCにインストールが必要な場合があります
2. **ファイアウォール**: ポート8765の通信を許可する必要があります
3. **管理者権限**: 一部のアプリケーション起動には管理者権限が必要な場合があります

## 自動ビルドスクリプト

便利なビルドスクリプトを作成できます：

```powershell
# build_release.ps1
Write-Host "EYM Agent リリースビルドを開始します..."

flutter clean
flutter pub get
flutter build windows --release

if ($LASTEXITCODE -eq 0) {
    Write-Host "ビルド成功！"
    Write-Host "実行ファイル: build/windows/x64/runner/Release/qrsc_pc.exe"
} else {
    Write-Host "ビルド失敗"
}
```

実行方法：
```bash
powershell -ExecutionPolicy Bypass -File build_release.ps1
