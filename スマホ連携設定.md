# スマホアプリとの連携設定

## 基本的な接続方法

### 1. PCのIPアドレスを確認

**localhost（127.0.0.1）はスマホからアクセスできません。**
PCの実際のIPアドレスを使用する必要があります。

#### Windows PowerShellで確認
```powershell
# IPアドレスを確認
ipconfig

# または、より詳細に
Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -ne "127.0.0.1"}
```

#### 例：PCのIPアドレスが `192.168.1.100` の場合
- ❌ 間違い: `http://localhost:8765`
- ✅ 正しい: `http://192.168.1.100:8765`

### 2. スマホ側の設定

既存のスマホMVPアプリで、以下のように設定してください：

```dart
// スマホアプリのコード例
final String pcServerUrl = 'http://192.168.1.100:8765'; // PCの実際のIPアドレス

// ボタン押下時の処理
Future<void> sendButtonPress(int buttonId) async {
  try {
    final response = await http.post(
      Uri.parse('$pcServerUrl/launch'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({'button_id': buttonId}),
    );
    
    if (response.statusCode == 200) {
      final result = jsonDecode(response.body);
      print('成功: ${result['message']}');
    } else {
      print('エラー: ${response.statusCode}');
    }
  } catch (e) {
    print('接続エラー: $e');
  }
}
```

## 詳細な設定手順

### Step 1: PC側の準備

1. **EYM Agentを起動**
```bash
# Web版の場合
flutter run -d chrome

# Windows ネイティブ版の場合
flutter run -d windows
# または
.\build_release.ps1
./build/windows/x64/runner/Release/eym_agent.exe
```

2. **IPアドレスを確認**
```powershell
ipconfig
```

出力例：
```
イーサネット アダプター イーサネット:
   IPv4 アドレス . . . . . . . . . . . .: 192.168.1.100
```

3. **ファイアウォール設定**
- Windows Defenderファイアウォールでポート8765を許可
- または、初回起動時に表示される許可ダイアログで「許可」をクリック

### Step 2: 接続テスト

#### PCのブラウザでテスト
```
http://192.168.1.100:8765/health
```
→ "ok" が表示されれば成功

#### スマホのブラウザでテスト
同じURLをスマホのブラウザで開いて確認：
```
http://192.168.1.100:8765/health
```

### Step 3: スマホアプリの設定

#### 設定画面を追加（推奨）
```dart
class SettingsScreen extends StatefulWidget {
  @override
  _SettingsScreenState createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  String _serverUrl = 'http://192.168.1.100:8765';
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('サーバー設定')),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              decoration: InputDecoration(
                labelText: 'PC サーバーURL',
                hintText: 'http://192.168.1.100:8765',
              ),
              value: _serverUrl,
              onChanged: (value) => setState(() => _serverUrl = value),
            ),
            ElevatedButton(
              onPressed: _testConnection,
              child: Text('接続テスト'),
            ),
          ],
        ),
      ),
    );
  }
  
  Future<void> _testConnection() async {
    try {
      final response = await http.get(Uri.parse('$_serverUrl/health'));
      if (response.statusCode == 200) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('接続成功！')),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('接続失敗: $e')),
      );
    }
  }
}
```

## API仕様

### エンドポイント一覧

#### 1. ヘルスチェック
```
GET http://192.168.1.100:8765/health
```
レスポンス: `"ok"`

#### 2. ショートカット一覧取得
```
GET http://192.168.1.100:8765/shortcuts
```
レスポンス:
```json
{
  "type": "shortcuts",
  "protocolVersion": 1,
  "data": [
    {
      "buttonId": 1,
      "name": "Button 1",
      "path": "notepad.exe",
      "args": []
    }
  ]
}
```

#### 3. アプリケーション起動（メイン機能）
```
POST http://192.168.1.100:8765/launch
Content-Type: application/json

{
  "button_id": 1
}
```
レスポンス:
```json
{
  "type": "result",
  "id": 1,
  "success": true,
  "message": "アプリケーションを起動しました"
}
```

## トラブルシューティング

### 問題1: 「接続できません」エラー

**原因**: IPアドレスが間違っている
**解決**: PCで `ipconfig` を実行して正しいIPアドレスを確認

### 問題2: 「タイムアウト」エラー

**原因**: ファイアウォールがポート8765をブロック
**解決**: 
1. Windows Defenderファイアウォールを開く
2. 「受信の規則」→「新しい規則」
3. 「ポート」→「TCP」→「特定のローカルポート: 8765」
4. 「接続を許可する」

### 問題3: 「404 Not Found」エラー

**原因**: EYM Agentが起動していない
**解決**: PCでEYM Agentアプリを起動

### 問題4: スマホとPCが異なるネットワーク

**原因**: スマホがモバイルデータ、PCがWi-Fi
**解決**: 両方を同じWi-Fiネットワークに接続

## セキュリティ注意事項

1. **ローカルネットワークのみ**: 外部からのアクセスは想定していません
2. **認証なし**: 現在のバージョンでは認証機能はありません
3. **暗号化なし**: HTTP通信のため、機密情報は送信しないでください

## 実際の使用例

### スマホアプリのボタン実装例
```dart
class RemoteButton extends StatelessWidget {
  final int buttonId;
  final String label;
  final String serverUrl;
  
  const RemoteButton({
    required this.buttonId,
    required this.label,
    required this.serverUrl,
  });
  
  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: () => _sendCommand(),
      child: Text(label),
    );
  }
  
  Future<void> _sendCommand() async {
    try {
      final response = await http.post(
        Uri.parse('$serverUrl/launch'),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'button_id': buttonId}),
      );
      
      if (response.statusCode == 200) {
        final result = jsonDecode(response.body);
        print('${result['success'] ? '成功' : '失敗'}: ${result['message']}');
      }
    } catch (e) {
      print('エラー: $e');
    }
  }
}
```

### 使用方法
```dart
// メイン画面で使用
RemoteButton(
  buttonId: 1,
  label: 'メモ帳を開く',
  serverUrl: 'http://192.168.1.100:8765',
)
```

これで、スマホから簡単にPCのアプリケーションを起動できます！
